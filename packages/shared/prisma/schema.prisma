generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Platform {
  INSTANTLY
  PLUSVIBE
}

enum ConversationStatus {
  OPEN
  PENDING
  CLOSED
}

enum MessageDirection {
  IN
  OUT
}

enum ReplyStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}

enum UserRole {
  ADMIN
  MANAGER
  SALES_REP
}

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String?
  passwordHash String? @map("password_hash")
  role        UserRole @default(SALES_REP)
  workspaceId String?  @map("workspace_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  platformConnections  PlatformConnection[]
  conversationAssignments ConversationAssignment[]
  conversationNotes   ConversationNote[]
  aiDrafts           AiDraft[]
  auditLogs           AuditLog[]
}

model Workspace {
  id          String   @id @default(cuid())
  externalId  String?  @unique @map("external_id")  // Platform's workspace/org ID
  name        String
  createdAt   DateTime @default(now()) @map("created_at")

  leads            Lead[]
  replyTemplates   ReplyTemplate[]
}

model Lead {
  id               String   @id @default(cuid())
  email            String
  firstName        String?  @map("first_name")
  lastName         String?  @map("last_name")
  companyName      String?  @map("company_name")
  sourcePlatform   Platform @map("source_platform")
  externalLeadId   String?  @map("external_lead_id")
  workspaceId      String   @map("workspace_id")
  metadata         Json?    // Flexible lead data (job_title, linkedin_url, etc.)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  workspace   Workspace    @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  conversations Conversation[]

  @@unique([email, workspaceId, sourcePlatform])
  @@index([email])
  @@index([workspaceId])
}

model PlatformConnection {
  id             String   @id @default(cuid())
  userId         String   @map("user_id")
  platform       Platform
  apiKeyEncrypted String  @map("api_key_encrypted")
  workspaceId    String?  @map("workspace_id")
  organizationId String?  @map("organization_id")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([platform])
}

model Conversation {
  id                 String             @id @default(cuid())
  leadId             String             @map("lead_id")
  platform           Platform
  externalThreadId   String             @map("external_thread_id")
  campaignId         String?            @map("campaign_id")
  campaignName       String?            @map("campaign_name")
  status             ConversationStatus @default(OPEN)
  assignedTo         String?            @map("assigned_to")
  lastMessageAt      DateTime?          @map("last_message_at")
  createdAt          DateTime           @default(now()) @map("created_at")
  updatedAt          DateTime           @updatedAt @map("updated_at")

  lead       Lead    @relation(fields: [leadId], references: [id], onDelete: Cascade)
  messages   Message[]
  labels     ConversationLabel[]
  notes      ConversationNote[]
  assignments ConversationAssignment[]
  outgoingReplies OutgoingReply[]
  aiDrafts   AiDraft[]

  @@unique([platform, externalThreadId])
  @@index([leadId])
  @@index([campaignId])
  @@index([status])
  @@index([assignedTo])
}

model Message {
  id               String          @id @default(cuid())
  conversationId   String          @map("conversation_id")
  platform         Platform
  externalMessageId String        @map("external_message_id")
  direction        MessageDirection
  subject          String
  bodyHtml         String?         @map("body_html")
  bodyText         String?         @map("body_text")
  fromEmail        String          @map("from_email")
  toEmail          String          @map("to_email")
  messageIdRfc     String?         @map("message_id_rfc")
  inReplyTo        String?         @map("in_reply_to")
  references       String?         @map("references")
  sentAt           DateTime        @map("sent_at")
  metadata         Json?           // eaccount, email_account_id, etc.
  createdAt        DateTime        @default(now()) @map("created_at")

  conversation   Conversation   @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  outgoingReplies OutgoingReply[]

  @@unique([platform, externalMessageId])
  @@index([conversationId])
}

model OutgoingReply {
  id             String     @id @default(cuid())
  messageId      String     @map("message_id")
  conversationId String     @map("conversation_id")
  platform       Platform
  status         ReplyStatus @default(PENDING)
  sentAt         DateTime?  @map("sent_at")
  errorMessage   String?    @map("error_message")
  metadata       Json?      // external reply id, etc.
  createdAt      DateTime   @default(now()) @map("created_at")

  message      Message      @relation(fields: [messageId], references: [id], onDelete: Cascade)
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([status])
}

model ConversationLabel {
  id             String   @id @default(cuid())
  conversationId String  @map("conversation_id")
  label          String  // INTERESTED, NOT_INTERESTED, FOLLOW_UP, WRONG_PERSON, etc.
  createdAt      DateTime @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([conversationId, label])
  @@index([conversationId])
  @@index([label])
}

model ConversationNote {
  id             String   @id @default(cuid())
  conversationId String   @map("conversation_id")
  userId         String   @map("user_id")
  content        String
  createdAt      DateTime @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model ConversationAssignment {
  id             String   @id @default(cuid())
  conversationId String   @map("conversation_id")
  userId         String   @map("user_id")
  assignedAt     DateTime @default(now()) @map("assigned_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId])
  @@index([userId])
}

model AiDraft {
  id               String   @id @default(cuid())
  conversationId    String   @map("conversation_id")
  userId           String   @map("user_id")
  promptContext    String?  @map("prompt_context")
  generatedContent String  @map("generated_content")
  editedContent    String?  @map("edited_content")
  createdAt        DateTime @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model ReplyTemplate {
  id          String   @id @default(cuid())
  workspaceId String   @map("workspace_id")
  name        String
  content     String
  variables   String[] // ["lead_name", "company", "campaign_name"]
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
}

model AuditLog {
  id         String   @id @default(cuid())
  entityType String   @map("entity_type")
  entityId   String   @map("entity_id")
  action     String
  userId     String?  @map("user_id")
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
}
